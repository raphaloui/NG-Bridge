<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <script src="https://noda.io/api/includes/noda.js"></script>

    <title>Noda Automation Bridge</title>

    <style>
        .status {
            padding: 5px;
            margin: 5px 0;
            border: 1px solid #ccc;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .events {
            height: 200px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 5px;
            background-color: #f8f9fa;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1>Noda Automation Bridge (User: <span id="userId"></span>)</h1>
                <p>Questo pannello mostra lo stato dell'integrazione VR & Google Apps Script.</p>
                <div id="status" class="status">
                    <p>Status: <span id="statusMessage">Inizializzazione Noda...</span></p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-6">
                <h3>Event Log</h3>
                <div id="events" class="events">
                    <p>Events: <span style="float:right;margin-right:10px"><a href="#" onclick="clearEvents()">Clear</a></span><br/><span id="eventsMessage"></span></p>
                </div>
            </div>
            
            <div class="col-6">
                <h3>Proprietà Nodo</h3>
                <form>
                    <div class="form-group">
                        <label>UUID</label>
                        <input type="text" class="form-control" id="nodePropsUuid" readonly>
                    </div>
                    <div class="form-group">
                        <label>Titolo</label>
                        <input type="text" class="form-control" id="nodePropsTitle" placeholder="Title">
                    </div>
                    <div class="form-group">
                        <label>Posizione (X, Y, Z)</label>
                        <div class="row">
                            <div class="col"><input type="number" class="form-control" id="nodePropsLocationX" placeholder="X"></div>
                            <div class="col"><input type="number" class="form-control" id="nodePropsLocationY" placeholder="Y"></div>
                            <div class="col"><input type="number" class="form-control" id="nodePropsLocationZ" placeholder="Z"></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <script>
        var statusElement;
        var statusMessageElement;
        var eventsMessageElement;

        // 1. DEFINIZIONI DELLE VARIABILI GLOBALI
        const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzrGZpFR9_cun8yByyssljuQveoMqBF9eYtg7CHFcPZGSiA1VhFqVE1-jr5irHbpXpdEw/exec'; // *** IL TUO URL API CONFERMATO ***
        const POSTAZIONE_DISTRIB_UUID = 'DISTRIB'; 
        const TOLERANCE = 3; // Tolleranza in unità Noda per definire la "vicinanza" (3 metri)

        document.addEventListener('DOMContentLoaded', function () {
            statusElement = document.getElementById('status');
            statusMessageElement = document.getElementById('statusMessage');
            eventsMessageElement = document.getElementById('eventsMessage');

            // Gestori di Eventi Noda
            window.noda.onNodeCreated = function (node) { eventMessage("Node created with uuid: " + node.uuid); }
            
            // ************ 2. IL TRIGGER DI AUTOMAZIONE (FATTO) ************
            window.noda.onNodeUpdated = function (node) {
                 eventMessage("Node updated with uuid: " + node.uuid);
                 
                 // Se il nodo è selezionato, mostriamo le sue proprietà nell'interfaccia 2D (funzione di base del plugin)
                 if(node.selected) {
                     showNodeProps(node);
                 }
                 
                 // LOGICA DI TRASCINAMENTO (TRIGGER SPAZIALE)
                 // Controlliamo se la postazione esiste e se il nodo mosso non è la postazione stessa
                 if (node.location && node.location.relativeTo === 'Origin' && node.uuid !== POSTAZIONE_DISTRIB_UUID) {
                    
                     // Coordinate target della postazione 'DISTRIB' (X:-12, Z:-3)
                     const targetX = -12; 
                     const targetY = 1.5; 
                     const targetZ = -3;
                     
                     // Calcola la distanza sul piano XZ
                     const distXZ = Math.sqrt(Math.pow(node.location.x - targetX, 2) + Math.pow(node.location.z - targetZ, 2)); 
                     
                     // Verifica se il nodo è nella zona di tolleranza (lo consideriamo "rilasciato" sulla postazione)
                     if (distXZ < TOLERANCE) { 
                         
                         // Azione Triggerata: Assegnazione Task
                         const assegnatarioDefault = "Chiara Verdi"; 
                         
                         // Invia il comando ad Apps Script
                         sendCommand('ASSIGN_TASK', node.uuid, POSTAZIONE_DISTRIB_UUID, assegnatarioDefault);
                         
                         // Feedback visivo immediato: muove il task alla posizione esatta della postazione
                         window.noda.updateNode({
                             uuid: node.uuid,
                             location: { x: targetX, y: targetY, z: targetZ }
                         });
                         
                         eventMessage(`SUCCESS: Task ${node.uuid} assegnato a ${assegnatarioDefault}!`);
                     }
                 }
            }
            // ************ FINE TRIGGER ************
            
            window.noda.onNodeDeleted = function (node) { eventMessage("Node deleted with uuid: " + node.uuid); }

            window.noda.onLinkCreated = function (link) { eventMessage("Link created with uuid: " + link.uuid); }
            window.noda.onLinkUpdated = function (link) {
                 eventMessage("Link updated with uuid: " + link.uuid);
                 if(link.selected) {
                     // Funzione showLinkProps omessa per brevità, ma necessaria in un setup completo
                 }
            }
            window.noda.onLinkDeleted = function (link) { eventMessage("Link deleted with uuid: " + link.uuid); } 

            window.noda.onInitialized = function () {
                if (!window.noda.isInstalled())
                    statusError("Noda VR context not found, please try from within VR app.");
                else
                    populateUser();
            }

        }, false);

        // 3. FUNZIONE DI INVIO WEBHOOK AD APPS SCRIPT
        async function sendCommand(actionType, nodeId, targetId, value) {
            try {
                const payload = {
                    action: actionType,
                    nodeId: nodeId,
                    targetId: targetId,
                    value: value
                };

                console.log("Sending payload:", payload);
                eventMessage(`Sending command: ${actionType} for node ${nodeId} to Google.`);
                
                const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Mantiene la compatibilità
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                statusSuccess(`Comando inviato: ${actionType} per nodo ${nodeId}`);
                return true;

            } catch (error) {
                statusError(`Errore invio comando: ${error}`);
                return false;
            }
        }

        // Funzioni Utilità Noda
        async function populateUser()
        {
            try {
                const user = await window.noda.getUser();
                document.getElementById('userId').textContent = user.userId;
            } catch (error) {
                statusError("Get User error: " + error);
            }
        }
        
        function statusSuccess(message) {
            statusMessageElement.textContent = message;
            statusElement.classList.remove('error');
            statusElement.classList.add('success');
        }

        function statusError(message) {
            statusMessageElement.textContent = message;
            statusElement.classList.add('error');
            statusElement.classList.remove('success');
        }

        function eventMessage(message) {
            eventsMessageElement.innerHTML = message + "<br/>" + eventsMessageElement.innerHTML;
        }

        function clearEvents() {
            eventsMessageElement.innerHTML = "";
        }
        
        // Funzioni per la gestione delle proprietà dei nodi (essenziali per onNodeUpdated)
        function showNodeProps(nodeProps) {
            document.getElementById('nodePropsUuid').value = nodeProps.uuid || '';
            document.getElementById('nodePropsTitle').value = nodeProps.title || '';
            
            if (nodeProps.location) {
                document.getElementById('nodePropsLocationX').value = nodeProps.location.x || 0;
                document.getElementById('nodePropsLocationY').value = nodeProps.location.y || 0;
                document.getElementById('nodePropsLocationZ').value = nodeProps.location.z || 0;
            } else {
                document.getElementById('nodePropsLocationX').value = 0;
                document.getElementById('nodePropsLocationY').value = 0;
                document.getElementById('nodePropsLocationZ').value = 0;
            }
            // Qui andrebbero altre proprietà se l'interfaccia fosse completa
        }
        
        // La funzione obtainNodeProps e le funzioni CRUD di esempio (createNode, updateNode, deleteNode, listNodes) 
        // non sono strettamente necessarie per *questo* trigger, ma dovrebbero essere incluse in un plugin completo. 
        // Ho incluso gli elementi essenziali per il funzionamento del trigger.
    </script>
</body>

</html>
